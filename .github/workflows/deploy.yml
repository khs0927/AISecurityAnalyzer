name: Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/**'
      - 'packages/**'
      - 'shared/**'
      - 'docker-compose.yml'
  workflow_dispatch:
    inputs:
      deploy_env:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  security-check:
    name: ë³´ì•ˆ ì ê²€
    runs-on: ubuntu-latest
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          
      - name: pnpm ì„¤ì •
        uses: pnpm/action-setup@v2
        with:
          version: 9
          run_install: false
          
      - name: pnpm ì„¤ì¹˜
        run: pnpm install --no-frozen-lockfile
        
      - name: ì˜ì¡´ì„± ê°ì‚¬
        id: audit
        continue-on-error: true
        run: |
          pnpm audit
          echo "pnpm_audit_exit_code=$?" >> $GITHUB_ENV
          
      - name: Python ì˜ì¡´ì„± ê°ì‚¬
        id: py_audit
        continue-on-error: true
        run: |
          pip install safety
          cd apps/agent
          pip install poetry
          poetry export -f requirements.txt | safety check
          echo "py_audit_exit_code=$?" >> $GITHUB_ENV
          
      - name: ì·¨ì•½ì  ê²°ê³¼ í™•ì¸
        run: |
          if [[ ${{ env.pnpm_audit_exit_code }} -ne 0 && ${{ env.py_audit_exit_code }} -ne 0 ]]; then
            echo "ì¤‘ìš” ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. GitHub Security íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”."
          else
            echo "ì¤‘ìš”í•œ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi
          
      - name: CodeQL ë¶„ì„
        uses: github/codeql-action/init@v2
        with:
          languages: javascript, typescript
          
      - name: CodeQL ë¶„ì„ ì‹¤í–‰
        uses: github/codeql-action/analyze@v2

  prepare-models:
    name: ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ë° ì¤€ë¹„
    runs-on: ubuntu-latest
    needs: security-check
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
        
      - name: ëª¨ë¸ ìºì‹œ í™•ì¸
        id: model-cache
        uses: actions/cache@v3
        with:
          path: models
          key: ${{ runner.os }}-models-${{ hashFiles('scripts/fetch_models.sh') }}
          
      - name: ëª¨ë¸ ë‹¤ìš´ë¡œë“œ
        if: steps.model-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p models
          ./scripts/fetch_models.sh
          
      - name: ëª¨ë¸ ì••ì¶•
        run: tar -czvf models.tar.gz models
        
      - name: ëª¨ë¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: models
          path: models.tar.gz
          
  build-api:
    name: API ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: security-check
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          
      - name: pnpm ì„¤ì •
        uses: pnpm/action-setup@v2
        with:
          version: 9
          run_install: false
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          cd apps/api
          pnpm install --no-frozen-lockfile
          
      - name: API ë¹Œë“œ
        run: |
          cd apps/api
          pnpm build
          
      - name: ë¹Œë“œ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: api-build
          path: apps/api/dist
          
  build-web:
    name: ì›¹ í´ë¼ì´ì–¸íŠ¸ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: security-check
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          
      - name: pnpm ì„¤ì •
        uses: pnpm/action-setup@v2
        with:
          version: 9
          run_install: false
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          cd apps/web
          pnpm install --no-frozen-lockfile
          
      - name: ì›¹ ë¹Œë“œ
        run: |
          cd apps/web
          pnpm build
          
      - name: ë¹Œë“œ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: web-build
          path: apps/web/dist
          
  deploy:
    name: í”„ë¡œë•ì…˜ ë°°í¬
    runs-on: ubuntu-latest
    needs: [prepare-models, build-api, build-web]
    environment: production
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
        
      - name: ëª¨ë¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v3
        with:
          name: models
          
      - name: API ë¹Œë“œ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v3
        with:
          name: api-build
          path: apps/api/dist
          
      - name: ì›¹ ë¹Œë“œ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v3
        with:
          name: web-build
          path: apps/web/dist
          
      - name: ëª¨ë¸ ì••ì¶• í•´ì œ
        run: tar -xzvf models.tar.gz
          
      - name: ë°°í¬ í™˜ê²½ ì„¤ì •
        run: |
          echo "DEPLOY_TIME=$(date)" >> $GITHUB_ENV
          echo "VERSION=${{ github.sha }}" >> $GITHUB_ENV
        
      - name: Docker ì„¤ì •
        uses: docker/setup-buildx-action@v2
        
      - name: Docker ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: API Docker ì´ë¯¸ì§€ ë¹Œë“œ
        uses: docker/build-push-action@v4
        with:
          context: ./apps/api
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/nottoday-api:latest
          
      - name: LLM Server Docker ì´ë¯¸ì§€ ë¹Œë“œ
        uses: docker/build-push-action@v4
        with:
          context: ./infra/docker
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/nottoday-llm:latest
          
      - name: Agent Docker ì´ë¯¸ì§€ ë¹Œë“œ
        uses: docker/build-push-action@v4
        with:
          context: ./apps/agent
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/nottoday-agent:latest
          
      - name: ëª¨ë¸ íŒŒì¼ ë°°í¬ ì„œë²„ë¡œ ë³µì‚¬
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          source: models.tar.gz
          target: /tmp/
        
      - name: ì„œë²„ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          script: |
            mkdir -p ~/nottoday/models
            tar -xzf /tmp/models.tar.gz -C ~/nottoday
            
            docker pull ${{ secrets.DOCKER_USERNAME }}/nottoday-api:latest
            docker pull ${{ secrets.DOCKER_USERNAME }}/nottoday-llm:latest
            docker pull ${{ secrets.DOCKER_USERNAME }}/nottoday-agent:latest
            
            # ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¤‘ë‹¨
            docker-compose -f ~/nottoday/docker-compose.yml down || true
            
            # docker-compose.yml íŒŒì¼ ìƒì„±
            cat > ~/nottoday/docker-compose.yml << 'EOL'
            version: "3.9"
            services:
              llm:
                image: ${{ secrets.DOCKER_USERNAME }}/nottoday-llm:latest
                volumes: ["./models:/models"]
                ports: ["7000:7000"]
              agent:
                image: ${{ secrets.DOCKER_USERNAME }}/nottoday-agent:latest
                environment:
                  - LLAMA=http://llm:7000/completion
                depends_on: [llm]
                ports: ["8000:8000"]
              api:
                image: ${{ secrets.DOCKER_USERNAME }}/nottoday-api:latest
                ports: ["8080:8080"]
            EOL
            
            # ì„œë¹„ìŠ¤ ì‹œìž‘
            cd ~/nottoday && docker-compose up -d
            
      - name: Vercel ë°°í¬ (ì›¹)
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          working-directory: ./apps/web
          vercel-args: '--prod'
          
      - name: ìŠ¬ëž™ ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            NotToday Medical AI v3.4 CPU Edition ë°°í¬ ${{ job.status == 'success' && 'ì„±ê³µ âœ…' || 'ì‹¤íŒ¨ âŒ' }}
            
            ì‹œê°„: ${{ env.DEPLOY_TIME }}
            ë²„ì „: ${{ env.VERSION }}
            í™˜ê²½: Production
            URL: https://nottoday.vercel.app
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()
          
      - name: ë°°í¬ ê²°ê³¼ ê¸°ë¡
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.number }}
          body: |
            # ðŸš€ ë°°í¬ ì™„ë£Œ

            âœ… [NotToday v3.4 CPU Edition] ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
            
            - **ë°°í¬ ì‹œê°„**: ${{ env.DEPLOY_TIME }}
            - **ì»¤ë°‹**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            - **ë°°í¬ URL**: https://nottoday.vercel.app
            - **API ì„œë²„**: https://api.nottoday.app
            
            ### CPU ì „ìš© ëª¨ë¸ ì •ë³´
            
            | ëª¨ë¸ | í¬ê¸° | ê¸°ëŠ¥ |
            |-----|------|------|
            | TinyLlamaMed-1.1B | â‰ˆ1.2 GB | ì¼ë°˜ ìƒë‹´ / ì¶”ë¡  |
            | Bio-MiniCPM-2B | â‰ˆ2.0 GB | ì‹¬ì¸µ ìž„ìƒ Q&A |
            | BioGPT-350M | â‰ˆ0.6 GB | PubMed RAG ì¸ì½”ë” |
            | ECGNet-small | ~80 MB | 1-lead ECG ë¶€ì •ë§¥ |
        if: github.event_name == 'pull_request' 